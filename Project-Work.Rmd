---
title: "Unmasking the Numbers"
subtitle: "An Analysis of the BNT162b2 mRNA Covid-19 Vaccine Efficacy Rate"
graphics: yes
author: "Nathan Dennis, Aarav Dewangan, Maxwell Wang"
output: 
        pdf_document:
         toc: false
         number_sections: false
urlcolor: blue+
header-includes:
- \usepackage{amsmath,amsfonts,amssymb}
- \usepackage{multicol,graphicx,hyperref,xcolor}
- \usepackage{setspace} \doublespacing
fontsize: 11pt
---

```{r setup, include=F}
library(dplyr)
library(fastR2)
library(ggplot2)
library(gridExtra)
library(LearnBayes)
library(maxLik)

options(pillar.sigfig=6)
```

# 1 Abstract

The COVID-19 (SARS-CoV-2) global pandemic's widespread health, economic, and social impact has necessitated the creation of effective vaccines. Pfizer's BNT162b2 vaccine is the first of its kind: an mRNA vaccine determined to stop the pandemic. A placebo-controlled experiment with nearly 35,000 participants was conducted to determine the efficacy of the BNT162b2 vaccine candidate. The results from this study are analyzed using three approaches: Bayesian, Frequentist (likelihood), and bootstrapping. We analyze whether or not the vaccines efficacy is greater than 30\%, required for FDA approval. Through using these approaches we created multiple measures to test the hypothesis such as credible intervals, where it was discovered the BNT162b2 vaccine successfully had greater than a 30\% vaccine efficacy using all three approaches.

## Keywords
COVID-19, Vaccine Efficacy, Posterior, Likelihood, Credible Interval

# 2 Introducton
This paper focuses on the COVID-19 pandemic. There have been over 700 million confirmed cases of COVID-19 since the pandemic was identified by the World Health Organization on March 11, 2020. The symptoms range from mild flu-like symptoms to more severe respiratory symptoms such as trouble breathing. This pandemic has led to the loss of 7 million human lives worldwide and has caused many challenges to public health, food systems, and the work force, to name a few (World Health Organization). The effect on the economy has been equally as devastating, with nearly half of the worlds' 3.3 billion global workforce at risk of losing their livelihoods (World Health Organization). 

Scientists and medical professionals have been working diligently to develop and test vaccines in hopes to counteract this virus. One of these vaccines was developed by Pfizer and BioNTech in December 2020 when they successfully obtained a US FDA Emergency Use Authorization, where they began to distribution their two-dose vaccine, BNT162b2. These vaccines must go through a testing trial, where randomly assigned participants will be assigned to a treatment/vaccine group and a control/placebo group. Such analysis may be compared to Sinovac Research & Development Co., Ltd's own COVID-19 vaccination efficacy trial, which used a similar approach (Sinovac). The point of these experiments are to test the vaccine efficacy, which is based on how many people who got vaccinated developed COVID-19 compared with how many people who got the placebo developed COVID-19 (Centers for Disease Control).

Now turning the focus to the BNT162b2 vaccine, a placebo-controlled, observer blinded efficacy study was conducted where randomly assigned persons 16 years or older in a 1:1 ratio received two doses, 21 days apart, of either the placebo or BNT162b2 vaccine. The key outcome of interest is the efficacy of the BNT162b2 vaccine. A vaccine efficacy greater than 30% is sufficient to obtain FDA approval.

# 3 Statistical Methods
## 3.1 Definitions & Initial Calculations

In this section, we need to make some calculations to create our statistical model. Let X denote the total number of laboratory confirmed Covid-19 cases among $n_1$ = 17411 subjects randomly assigned to the BNT162b2 vaccine group and let Y denote the total number of laboratory confirmed Covid-19 cases among $n_2$ = 17511 subjects randomly assigned to the placebo group. Also, let parameters $\pi_p$ represent the probability of being infected with Covid-19 for an individual in the placebo group, and $\pi_v$ to represent the probability of being infected with Covid-19 for an individual in the vaccine group. It is noteworthy that X is independent of Y.
\begin{align*}
X \sim Binom(n_1,\pi_v) & & \ Y \sim Binom(n_2,\pi_p)
\end{align*}
We have a total of X + Y = s COVID-19 cases observed where now let T denote the number of individuals who were in the BNT162b2 vaccine group from the s = 170 patients who got COVID-19. T then follows the distribution: $T \sim Binom(s,\pi)$. We can now solve for $\pi$.

First, define the following variables for simplicity: Let V: A randomly assigned persons is in the vaccine group. Let
C: A randomly assigned persons is in the placebo group. Let I: A laboratory confirmed COVID-19 infection. Also, recall the distribution of T well approximated by binomial for the BNT162b2 group study. Therefore: $T \sim Binom(s,\pi)$, where $\pi=P(\mbox{V}|\mbox{I})$

Using Bayes Theorem, we can define $\pi$ as $\pi = \frac{P(I|V)P(V)}{P(I)} = \frac{P(I|V)P(V)}{P(I|V)P(V) + P(I|C)P(C)}$. Each of these probabilities can be solved for.

$\textbf{Calculation of } \pi:$ Given these probabilities, we can now calculate $\pi = \frac{\pi_v\frac{n_1}{n_1+n_2}}{\frac{\pi_v n_1 + \pi_p n_2}{n_1+n_2}} = \frac{\pi_v n_1}{\pi_v n_1 + \pi_p n_2}$.

When $n_1\approx n_2$, we say randomization is 1:1 and are able to simplify $\pi$ further: $\pi = \frac{\pi_v}{\pi_v+\pi_p}$

From here, the parameter of interest is the vaccine efficacy $\psi$, which is written as $\psi=\frac{\pi_p- \pi_v}{\pi_p}$. Given $\pi = \frac{\pi_v}{\pi_v+\pi_p}$, rearranging yields $\pi\pi_v+\pi\pi_p = \pi_v$. Furthermore, by grouping $\pi_v$ the result is as follows: $\pi_v(1-\pi) = \pi\pi_p$, then $\pi_v = \frac{\pi\pi_p}{1-\pi}$.

$\textbf{Calculation of } \psi:$ Plug this into $\psi = \frac{\pi_p- \pi_v}{\pi_p} = 1-\frac{\pi_v}{\pi_p}$, we get that $\psi = 1-\frac{\pi_v}{\pi_p} = 1-\frac{\pi\pi_p}{(1-\pi)\pi_p}$. Dividing by $\pi_p$ on the right, $\psi = 1-\frac{\pi}{1-\pi} = \frac{1-2\pi}{1-\pi}$. So, $\psi = \frac{1-2\pi}{1-\pi}$.

With this definition, we can construct the hypothesis of interest for $\psi$. The FDA requires at least 30% efficacy for a new therapy to be approved. The null hypothesis is $H_0: \psi \leq 0.3$, and the alternative is $H_1: \psi > 0.3$.

Within this section the following rearrangement of terms is used, given $\psi = \frac{1-2\pi}{1-\pi}$, we rearranged to get $\pi = \frac{1 -\psi}{2-\psi}$ 

We can proceed with the three approaches to analyze the data.

## 3.2 Bayesian Approach
### (1) Prior from Polack et. al.

Previously we defined $T \sim Binom(170,\pi)$ where $\pi=\frac{\pi_v}{\pi_v+\pi_p}$. We will also use the prior distribution for $\pi$, $g(\pi) = Beta(0.700102,1)$ as reported by Polack et. al. In the article, it was also mentioned that the 95% confidence interval for $\pi$ is (0.005148, 0.964483) and the corresponding 95\% interval for $\psi$ is (-26.2, 0.995). This implies we have enough room for uncertainty.

We know beta is a conjugate prior in the binomial model. In the other words, posterior distribution of $\pi$ is also a beta distribution, namely $h(\pi_0|x) = Beta(t+\alpha_0, 170 - t + \beta_0)$ given $g(\pi_0) = Beta(\alpha_0, \beta_0)$ in the binomial model, where t=8 in the dataset where there were 8 individuals in the vaccine group over all 170 cases. (Theorem 1) Using this fact to calculate the posterior:

$h(\pi_0|t)=Beta(0.700102+8,170-8+1)$ = $h(\pi_0|t)=Beta(8.700102,163)$

Using this posterior distribution we can find the 95% Bayesian credible interval for $\pi_0$, where we transform this for the vaccine efficacy, $\psi = \frac{1-2\pi}{1-\pi}$, and calculate a p-value to test the null hypothesis. We use a 95% interval similar to that used in the previous study. Building off the credible interval we can also calculate the posterior median for $\pi$ in order to obtain the posterior median for $\psi$, finding the 0.5 percentile for the posterior distribution for $\pi$ to do so.




### (2) Alternative Beta Prior, Further Pessimistic Approach

Polack et. al. cites a prior distribution for $\pi$ of $\mbox{Beta}(0.700102, 1)$ which is intended to be centered at $\pi = 0.4118$ corresponding to a $\psi$ of 30\%. The authors cite this as a pessimistic estimate. However, we will try a more pessimistic prior, where the median percentile of vaccine efficacy rate is 0\% and 95th percentile is 0.2. A "pessimistic" prior would represent a more skeptical approach in regards to vaccine efficacy. In many cases it is argued that pessimistic priors are rarely necessary since researchers are motivated to conduct a trial with a belief that the vaccine will be beneficial, however this is a flawed argument since in many cases prior beliefs about some intervention could prove to be inaccurate, causing significantly more harm. (Zampieri, Fernando G, et al.) Due to this, using this prior is a safe option to eliminate the possibility of substantial harm and would be useful to compare with the first prior calculation.

Using software one can observe the quantiles which correspond to this value within a beta distributon are $\alpha=\beta=109.29$. This corresponds to a prior of $g(\pi_0) = Beta(109.29, 109.29)$. Using Theorem 1, we see that the posterior takes the form: $h(\pi_0|t)=Beta(109.29+8,170-8+109.29) = Beta(117.29, 271.29)$.

Using this posterior distribution we can find the 95% Bayesian credible interval for $\pi_0$, where we transform this for the vaccine efficacy, $\psi = \frac{1-2\pi}{1-\pi}$ and calculate a p-value to test the null hypothesis. We use a 95% interval similar to that used in the previous study. Building off the credible interval we can also calculate the posterior median for $\pi$ in order to obtain the posterior median for $\psi$.



### (3) Poisson Distribution - Gamma Prior

So far we have constructed beta priors and posteriors from the Binomial distribution. Suppose now we can construct a Poisson distribution using the previous binomial distribution defined as $T \sim Binom(170, \pi)$. A good approximation for the binomial when the number of samples is large would be a poisson distribution with $\lambda = 170\pi$. We can denote $U \sim Poisson(\lambda = 170\pi)$, where $\lambda$ represents the rate of covid cases in the vaccine group over 170 positive cases and U represents the number of covid cases in the vaccine group over the 170 positive cases.

For a Poisson distribution, we utilize Jeffreys prior for the rate parameter $\lambda \geq 0$, which states that $p(\lambda) = \sqrt{\frac{1}{\lambda}}$. (Fan & Theorem 2) However, this can also be thought of as a $Gamma(\frac{1}{2},0)$ distribution, which implies the posterior takes the form $\lambda|u \sim Gamma(\frac{1}{2}+u,170)$. (Fan & Theorem 2) Using this posterior we again create a 95% Bayesian credible interval for $\pi_0$, where we transform this for the vaccine efficacy, $\psi = \frac{1-2\pi}{1-\pi}$ and calculate a p-value to test the null hypothesis.


## 3.3 Maximum-Likelihood Estimation

We want to make a maximum-likelihood estimator for $\psi$, $\widehat{\psi^{mle}}$, given the observed data. Let us start by writing the likelihood function. We have shown previously that $T\sim Binom(170,\pi)$, where the distribution would be defined as: $f(t|\pi) = {170\choose t} \pi^t \cdot (1 - \pi)^{170-t}$, where there are 170 total positive COVID-19 cases. We need to reparamaterize this with $\psi$, which represents the number of patients who contracted COVID who had initially been in the vaccinated group rather than the placebo. We use the fact that $\psi = \frac{1-2\pi}{1-\pi}$, where we previously rearranged terms and found $\pi = \frac{1 -\psi}{2-\psi}$.

Plugging in this value for $\pi$, we now have that $L(\psi) = f(t|\psi) = {170\choose t} (\frac{1 -\psi}{2-\psi})^t \cdot (1 - \frac{1 -\psi}{2-\psi})^{170-t}$. So the likelihood function is as follows: 
\begin{align*}
L(\psi) &= {170\choose t} (\frac{1 -\psi}{2-\psi})^t \cdot (1 - \frac{1 -\psi}{2-\psi})^{170-t} = {170\choose t} (\frac{1 -\psi}{2-\psi})^t \cdot (\frac{1}{2-\psi})^{170-t} \ \text{$\infty < \psi \leq 1$}
\end{align*}
Next, we compute the log-likelihood function by taking the natural log of the likelihood function. We denote this log-likelihood as $\ell(\psi) = \ln(L(\psi)) = \ln(f(t | \psi)) = \ln \left({170\choose t} (\frac{1 -\psi}{2-\psi})^t \cdot (\frac{1}{2-\psi})^{170-t} \right)$.
\begin{align*}
\ell(\psi) &= \ln \left({170\choose t} (\frac{1 -\psi}{2-\psi})^t \cdot (\frac{1}{2-\psi})^{170-t} \right) \\
&= \ln{170\choose t} + \ln\left((\frac{1 -\psi}{2-\psi})^t \right) + \ln \left((\frac{1}{2-\psi})^{170-t} \right) \\
&= \ln{170\choose t} + t\ln(\frac{1 -\psi}{2-\psi}) + (170-t)\ln(\frac{1}{2-\psi}) \\
&= \ln{170\choose t} + t\ln(1 -\psi) - t\ln(2-\psi) + (170-t)\ln(1) - (170-t)\ln(2-\psi) \\
&= \ln{170\choose t} + t\ln(1 -\psi) - 170\ln(2-\psi)
\end{align*}
We have calculated the log-likelihood $\ell(\psi) = \ln{170\choose t} + t\ln(1 -\psi) - 170\ln(2-\psi)$. To find the maximum of the likelihood function, we now take derivative of the log-likelihood and set it to zero. First, take the derivative with respect to $\psi$.
\begin{align*}
\frac{d}{d\psi} \ell(\psi) &= \frac{d}{d\psi} \left(\ln{170\choose t} + t\ln(1 -\psi) - 170\ln(2-\psi) \right) = 0 - \frac{t}{1-\psi} + \frac{170}{2-\psi}
\end{align*}
Using this derivative, we can set it equal to 0 to solve for the critical point $\psi$, MLE candidate:
\begin{align*}
0 &= - \frac{t}{1-\psi} + \frac{170}{2-\psi} \\
\frac{t}{1-\psi} &=  \frac{170}{2-\psi} \\
2t-t\psi &=  170-170\psi \implies 2t-170 = t\psi-170\psi \\
\psi &= \frac{2t-170}{t-170}
\end{align*}
So, $\hat{\psi_0}^{mle} = \frac{2t-170}{t-170}$. In our case, we have that t=8, since T represents the number of covid cases in the vaccine group within the 170 cases, we have given in the dataset (Table 1) t=8 and can plug this value in to solve for $\hat{\psi_0}^{mle}$ in the results. However, to prove that this critical point is a maximum we utilize the second derivative test.
\begin{align*}
\frac{d^2}{d\psi^2} \ell(\psi) &= \frac{d}{d\psi} \left(- \frac{t}{1-\psi} + \frac{170}{2-\psi} \right) = -\frac{t}{(1-\psi)^2} + \frac{170}{(2-\psi)^2}
\end{align*}
From here we plug in the critical point, $\hat{\psi_0}^{mle}$, we found:
\begin{align*}
\frac{d^2}{d\psi^2} \ell(\psi) &= -\frac{t}{(1-\frac{2t-170}{t-170})^2} + \frac{170}{(2-\frac{2t-170}{t-170})^2} \implies -\frac{t}{(\frac{-t}{t-170})^2} + \frac{170}{(\frac{170}{t-170})^2} \\
&= -\frac{1}{t}(t-170)^2 + \frac{1}{170}(t-170)^2 \\
&= \left(\frac{1}{170}-\frac{1}{t} \right)(t-170)^2
\end{align*}
We know that t cannot be a negative number and that $t \leq 170$ since there are 170 positive cases. So, the corresponding fraction $\frac{1}{170}-\frac{1}{t} \leq 0$ and the square term must be positive, so $\frac{d^2}{d\psi^2} \ell(\hat{\psi_0}^{mle}) < 0$, implying the critical point and hence MLE is a maximum.\
We now have our estimate for $\psi$, where we can assess regulatory conditions. Suppose we now have that $T_1,T_2, \dots T_{170} \sim Bernoulli(\pi)$, representing the 170 total infections within the study. Since the number of cases in large, under certain regulatory conditions $\hat{\psi_0}^{mle} \sim Norm \left(\psi, \frac{1}{\sqrt{-\ell''(\hat{\psi_0}^{mle})}} \right)$. We discuss the conditions as we observe a second order Taylor approximation of the log-likelihood function of $\psi$.

```{r, echo=F, warning=F, out.width="60%"}

t <- 8 #Observed 8 COVID-19 cases in vaccine group over total number of cases

# Calculate MLE Given equation
mle_psi <- (2*t-170)/(t-170)
# Log-likelihood function
loglik.psi <- function(psi){
  ifelse(psi > 1, NA,
         log(choose(170,8))+8*log(1-psi)-170*log(2-psi))
}

# Second order taylor approximation of the log-likelihood
second_order <- maxLik2(loglik=loglik.psi,
                        start=mle_psi,
                        method="NR")
# Plot this taylor approximation
plot <- plot(second_order) %>%
  gf_labs(title="Second Order Taylor Series Approximation of Log-Likelihood of Psi",
          x=expression(psi),
          y="Log-Likelihood")
plot
```

The conditions we assess are that the possible values of our parameter and bounds don't depend on $\psi$, and that the true value of $\psi$ does not fall on a boundary. We see in the plot that the second order taylor series approximation for $\psi$ is a very good fit and the estimated value for $\psi$ isn't too close to a boundary. Thus, we have that the normality of the MLE for $\psi$ holds.
Next we want to construct a 95% Wald confidence interval for $\psi$, so we first compute the standard error which is defined to be $\hat{SE}(\hat{\psi_0}^{mle}) = \frac{1}{\sqrt{-\ell''(\hat{\psi_0}^{mle})}} = \frac{1}{\sqrt{\left(\frac{1}{170}-\frac{1}{t} \right)(t-170)^2}}$, where again we know t=8 in the dataset from Table 1 and we can find this in the results. The Wald confidence interval is defined to take the form: ($z_{\alpha/2}$ is the 1 - $\frac{\alpha}{2}$th quantile of a standard normal)
\begin{align*}
\hat{\psi_0}^{mle} \pm z_{\alpha/2}\sqrt{\frac{1}{-\ell''(\hat{\psi_0}^{mle})}}
\end{align*}
Finally, we utilize the likelihood ratio test for the hypothesis: $H_0: \psi_0=0.3$ and $H_1: \psi_0 \neq 0.3$. This is defined to be $W = 2\ln \left[\frac{\hat{\psi_0}^{mle}}{\psi^{null}} \right]$. Under the null, $W \approx \chi_1^2$. Given the equations provided previously, the statistic takes the form:
\begin{align*}
W = 2\ln \left[\frac{{170\choose t}\left(\frac{1-\hat{\psi_0}^{mle}}{2-\hat{\psi_0}^{mle}} \right)^t \left(\frac{1}{2-\hat{\psi_0}^{mle}} \right)^{170-t}}{{170\choose t}\left(\frac{1-\psi_0^{null}}{2-\psi_0^{null}} \right)^t \left(\frac{1}{2-\psi_0^{null}} \right)^{170-t}} \right]
\end{align*}
Where we observed t=8 in the data. We use this to create a p-value and test the hypotheses


## 3.4 Bootstrap Confidence Interval

Using $\hat{\pi_p}$ and $\hat{\pi_v}$ from the data as the parameters for our binomial distributions X and Y (see section 3.1), we will run a parametric bootstrap simulation with B = 10,000 trials and construct a corresponding bootstrap confidence interval. Recall vaccine efficacy $\psi$ is defined as $\frac{\pi_p - \pi_v}{\pi_p} = 1 - \frac{\pi_v}{\pi_p}$. So in terms of our bootstrap, $\psi \approx 1 - \frac{X/n}{Y/m}$.

The bootstrap simulation will take 10,000 samples of $X$ and $Y$ from $X \sim \mbox{Binom}(17411, 8/17411)$, $Y \sim \mbox{Binom}(17511, 162/17511)$.

# 4 Results

First, we display the table, denoted Table 1, which corresponds to the data obtained in the BNT162b2 vaccines trials.

\begin{table}[ht]
\centering
\caption{Vaccine Efficacy against Covid-19 at least 7 days after second dose in pations without evidence of infection}
\begin{tabular}{|c|c|c|}
\hline
Groups & Cases & No. of Subjects \\
\hline
BNT162b2 & 8 & 17,411 \\
\hline
Placebo & 162 & 17,511 \\
\hline
Total & 170 & 34,922 \\

\hline
\end{tabular}
\end{table}

Using Table 1, we observe that there is nearly a 1:1 ratio for number of subjects in the vaccine and placebo group, which is expected from the study. We can calculate the vaccine efficacy strictly based on the given results in the table. First, we have that $\hat \pi_v=\frac{8}{17411}$ which represents the probability of infection for someone in the vaccine group and $\hat \pi_p=\frac{162}{17511}$ which represents the probability of infection for someone in the placebo group. So, we calculate $\hat\psi=\frac{\hat \pi_p-\hat \pi_v}{\hat \pi_p}=\frac{\frac{162}{17511}-\frac{8}{17411}}{\frac{162}{17511}}$ this simplifies too: $\hat\psi=\frac{446749}{470097} =0.950334$ as the observed vaccine efficacy.


## 4.1 Prior 1: Beta(0.700102, 1)
We calculate the 95% credible interval for $\pi_0$, [0.023194, 0.08799], and the posterior median as $\pi_0 = 0.048932$. We can convert this to create an interval for $\psi$ using the fact that $\psi = \frac{1-2\pi}{1-\pi}$, plugging in the credible interval values. We obtained a 95% Bayesian credible interval reported as [0.903512, 0.976255].

We can also calculate a p-value for this to confirm our beliefs. As a reminder, $H_0: \psi_0 \leq 0.3$ and $H_1: \psi_0>0.3$, where the p-value was calculated to be $1.960014 \times 10^{-28}$, which is nearly 0.

Furthermore, we calculate the posterior median as $\pi_0 = 0.048932$. We the see that the posterior median for $\psi$ comes out to be 0.948551, which is extremely large.

## 4.2 Prior 2: Beta(109.29, 109.29)
Using R software we calculate the 95% credible interval for $\pi_0$ to be [0.257257, 0.348361]. We again convert this to create an interval for $\psi$ using the equality $\psi = \frac{1-2\pi}{1-\pi}$. So our 95\% interval for $\psi$ is [0.465409, 0.65364]. 

Again we can also calculate a p-value under the hypothesis: $H_0: \psi_0<=0.3$ and $H_1: \psi_0>0.3$, where the p-value was calculated to be $6.306123 \times 10^{-8}$, which is nearly 0.

Furthermore, we calculate the posterior median as $\pi_0 = 0.274467$. We the see that the posterior median for $\psi$ comes out to be 0.621702, which is pretty large.

## 4.3 Prior 3: Gamma(1/2, 0)
Using R software we calculate the 95% credible interval for $\pi_0$ to be [0.022248, 0.088797]. We can convert this to create an interval for $\psi$ using the fact that $\psi = \frac{1-2\pi}{1-\pi}$, plugging in the credible interval values. We obtained a 95% Bayesian credible interval reported as [0.90255, 0.977246]. 

We can also calculate a p-value for this under $H_0: \psi_0<=0.3$ and $H_1: \psi_0>0.3$, where the p-value was calculated to be $2.181923 \times 10^{-21}$, which is nearly 0.

Furthermore, we calculate the posterior median as $\pi_0 = 0.048053$. We the see that the posterior median for $\psi$ comes out to be 0.949521, which is extremely large.

## 4.4 Table for Overall Bayesian Inference

\begin{table}[ht]
\centering
\caption{Bayesian Inference}
\begin{tabular}{|c|c|c|c|}
\hline
Prior & Median for $\psi$ & 95\% Credible Interval for $\psi$ & p-value\\
\hline
Beta(0.700102, 1) & 0.948551 & [0.903512, 0.976255] & $1.960014 \times 10^{-28}$ \\
\hline
Beta(109.29, 109.29) & 0.621702 & [0.465409, 0.65364]  & $6.306123 \times 10^{-8}$ \\
\hline
Gamma($\frac{1}{2}$, 0) & 0.949521 & [0.90255, 0.977246]  & $2.181923 \times 10^{-21}$ \\

\hline
\end{tabular}
\end{table}

## 4.5 Maximum-Likelihood

### Likelihood Calculations

```{r, eval=F,include=F}

t <- 8 #Observed 8 COVID-19 cases in vaccine group over total number of cases

# Calculate MLE Given equation
mle_psi <- (2*t-170)/(t-170)

# Calculate estimated standard error of Psi given equation
psi_se <- 1/sqrt((1/t-1/170)*(t-170)^2)

# 95% Wald Confidence Interval
lower_ci <- mle_psi - qnorm(0.975) * psi_se
upper_ci <- mle_psi + qnorm(0.975) * psi_se

# W statistic, likelihood ratio test
w_obs <- 2 * log((((1-mle_psi)/(2-mle_psi))^8 * 
                (1/(2-mle_psi))^162)/(((1-0.3)/(2-0.3))^8 * (1/(2-0.3))^162))


#Likelihood Ratio test p-value
p_value <- pchisq(w_obs, df=1, lower.tail=F)

```


We use the derivation for the maximum likelihood for $\psi$, with t=8 from Table 1, to get: $\hat{\psi_0}^{mle} = \frac{170-2t}{170-t}= \frac{170-2\cdot8}{170-8} = \frac{77}{81}$. We showed that the second derivative yield a negative value, so this is a maximum. 

We calculated the standard error for the MLE as $\frac{1}{\sqrt{\left(\frac{1}{170}-\frac{1}{8} \right)(8-170)^2}} \approx 0.017885$. We then construct a 95% Wald Confidence interval around this estimator, which was [0.915563, 0.985672] using $\frac{77}{81} \pm 1.96\frac{1}{\sqrt{\left(\frac{1}{170}-\frac{1}{8} \right)(8-170)^2}}$.

Furthermore, we can calculate the w-statistic from the likelihood ratio test where the equation was defined previously, which came out to be 121.6012 with a corresponding p-value of $2.82294 \times 10^{-28}$.


### Regulatory Conditions for Likelihood
```{r, eval=F,include=F}
# Log-likelihood function
loglik.psi <- function(psi){
  ifelse(psi > 1, NA,
         log(choose(170,8))+8*log(1-psi)-170*log(2-psi))
}
```

## 4.6 Bootstrap Confidence Interval
```{r label ="bootstrap", include=F, cache = TRUE, warning = FALSE}
# Requirements
set.seed(342)

# Data from study
n <- 17411
m <- 17511
pi_v_hat <- 8/n
pi_p_hat <- 162/m

# Helper function to compute psi from bootstrapped data
get_efficacy <- function(x_bar, y_bar) {
  1 - (x_bar / y_bar)
}

# Number of trials, B
B <- 10000
# Vaccine efficacy psi for our dataset
psi <- get_efficacy(pi_v_hat, pi_p_hat)

# Run bootstrap
boot_sim <- lapply(1:B, FUN = function(i){ 
    # generate a re-sample from known distribution
    x_bar = rbinom(1, n, pi_v_hat) / n
    y_bar = rbinom(1, m, pi_p_hat) / m
    
    #calculate bootstrapped efficacy and return value as dataframe
    psi_bootstrapped = get_efficacy(x_bar, y_bar)
    data.frame(psi_bootstrapped)
   })

boot_sim_psi <- do.call(rbind, boot_sim)

# Large histogram
p1 <- ggplot(data=boot_sim_psi, 
       mapping = aes(psi_bootstrapped))+
  geom_histogram(binwidth =0.01)+
  labs(title="Histogram of 10,000 Bootstrapped Vaccine Efficacy Rates",x="VE",
       y="Count")+xlim(0, 1)

# Detailed histogram with normality
p2_1 <- ggplot(data=boot_sim_psi, 
       mapping = aes(psi_bootstrapped))+
  geom_histogram(binwidth =0.005)+
  labs(title="Histogram of 10,000 Bootstrapped Vaccine Efficacy Rates",x="VE",
       y="Count")+xlim(0.8, 1)

# Normal qq
p2_2 <- ggplot(data = boot_sim_psi,
             mapping = aes(sample = psi_bootstrapped)) +
  stat_qq(distribution = qnorm) + 
  stat_qq_line(distribution = qnorm) + 
  labs(title = "Normal probability plot",
       subtitle = "of bootstrapped distribution")

# Center of bootstrapped confidence interval for psi
bootstrapped_center <-mean(boot_sim_psi$psi_bootstrapped)

# Compute Bootstrap confidence interval
# Percentile method
percentile_method<-boot_sim_psi %>% 
  summarize(lower = quantile(psi_bootstrapped,.025),
    upper = quantile(psi_bootstrapped, .975))
percentile_method # See output

median <- quantile(boot_sim_psi$psi_bootstrapped, 0.5)

# Bias adjusted Standard bootstrap method
standard_bootstrap<-boot_sim_psi %>% summarise(boot_mean=mean(psi_bootstrapped),
                          boot_se = sd(psi_bootstrapped),
                          bias = boot_mean-psi,
                          lower = psi + qnorm(p=0.025) * boot_se,
                          upper = psi - qnorm(p=0.025) * boot_se)

standard_bootstrap # See output

summary_table <- matrix(c(percentile_method$lower,percentile_method$upper,
                          standard_bootstrap$lower,standard_bootstrap$upper),
                        ncol=2,byrow=TRUE)
colnames(summary_table) <- c("Lower","Upper")
rownames(summary_table) <- c("Percentile Method","Standard Bootstrap")
summary_table <- as.table(summary_table)
```

The bootstrapped data was as follows. We check for normality:
```{r figure 4.6.1, echo = F, warning = FALSE, out.width="80%"}
grid.arrange(p2_1, p2_2)
```

From the code in our appendix, we calculated the following confidence intervals for vaccine efficacy $\psi$.
\begin{table}[ht]
\centering
\caption{Bootstrapped Confidence Intervals for $\psi$}
\begin{tabular}{|c|c|c|}
\hline
 & Lower & Upper \\
\hline
Percentile Method & 0.912194 & 0.982040 \\
\hline
Standard Bootstrap & 0.915071 & 0.985596 \\
\hline
\end{tabular}
\end{table}

Based on the Normal Q-Q plot, we conclude that the bootstrapped distribution is not nearly normal as the tail ends of the Q-Q plot differ from the expected values should our bootstrapped values of $\psi$ come from a normal distribution. Therefore, we should prefer the percentile method 95\% confidence interval for $\psi$ instead.

# 5 Discussion/Conclusion

Using the Bayesian methods and 3 priors examined, all 3 priors had 95% credible intervals which do not contain the value 0.3 and are completely above this value. The intervals for the first prior, used from the study, and third prior, using the Gamma prior, were around the same and both above 90%. The second prior, using a very pessimistic approach, was smaller than these 2 credible intervals, but still above 0.3. We can conclude using these credible intervals that the vaccine efficacy is better than 30\%. We also calculated p-values for all 3 prior approaches, but all p-values were notably nearly 0 with the hypothesis $H_0: \psi_0<=0.3$ and $H_1: \psi_0>0.3$. So, since these p-value are below the significance level of 0.05 and are nearly 0 we have enough evidence to reject the null in favor of the alternative, concluding vaccine efficacy for the BNT162b2 vaccine is greater than 30\%.

As stated, all 3 different methods produced the same conclusion. The extremely pessimistic prior produced results which were much more different than the other two, but it could be stronger since the assumption about the prior is much more biased towards the vaccine efficacy rate smaller than 30\%. Concluding that the vaccine's efficacy rate is greater than 30\% using a prior which gives that an extremely low probability makes the argument very strong.

Moving on to the Frequentist approach, we calculated $\hat{\psi_0}^{mle} = \frac{77}{81}$. We see that this value is very large, as the estimated vaccine effiacy rate is around 0.950617. The MLE allows us to estimate the parameters of our model which maximimizes the likelihood function, we have a very large estimate. Furthermore, we calculated the wald confidence interval. This helps provide an estimate for the range of our parameter, a range of values within the true parameter, which we saw was [0.915563, 0.985672]. We are 95% confident that the true parameter, $\psi$ falls in the range [0.915563, 0.985672]. We can see this confidence interval is well above 0.3, so there is strong evidence the vaccine efficacy is greater than 0.3. 

However, we also calculated the likelihood ratio and W statistic. The W statistic calculated was 121.6012, where large values of W are known to provide evidence in favor of the alternative, in this case $\psi_0 \neq 0.3$. The p-value also was extremely small and basically 0, where we can safely reject the null in favor of the alternative. Overall, this approach also concludes the vaccine efficacy is not 0.3, but is larger.

Finally, our bootstrapped confidence interval using the percentile method for $\psi$ found that we are 95\% confident that the true vaccine efficacy is between [0.9110567, 0.9817138] (see Table 3), with our median bootstrapped $\psi = 0.95145$. Our entire confidence interval lies above 30\% so there is sufficient statistical evidence to conclude that the vaccine is sufficiently effective. Therefore, we can safely reject the null hypothesis.

# 6 References
Centers for Disease Control. “Vaccine Effectiveness Studies.” Centers for Disease Control and Prevention, www.cdc.gov/coronavirus/2019-ncov/vaccines/effectiveness/how-they-work.html. Accessed 4 June 2023. 

Fan, Zhou. Lecture 20 | Bayesian Analysis - Stanford University, Nov. 2016, \
web.stanford.edu/class/stats200/Lecture20.pdf. 

Sinovac. “Clinical Trial of Efficacy and Safety of Sinovac’s Adsorbed COVID-19 (Inactivated) Vaccine in Healthcare Professionals - Full Text View.” Clinical Trial of Efficacy and Safety of Sinovac’s Adsorbed COVID-19 (Inactivated) Vaccine in Healthcare Professionals - Full Text View - ClinicalTrials.Gov, July 2020, clinicaltrials.gov/ct2/show/NCT04456595. 

World Health Organization. “Impact of Covid-19 on People’s Livelihoods, Their Health and Our Food Systems.” World Health Organization, 13 Oct. 2020, www.who.int/news/item/13-10-2020-impact-of-covid-19-on-people%27s-livelihoods-their-health-and-our-food-systems. 

Zampieri, Fernando G, et al. “Using Bayesian Methods to Augment the Interpretation of Critical Care Trials. an Overview of Theory and Example Reanalysis of the Alveolar Recruitment for Acute Respiratory Distress Syndrome Trial.” American Journal of Respiratory and Critical Care Medicine, 1 Mar. 2021, www.ncbi.nlm.nih.gov/pmc/articles/PMC7924582/.


\pagebreak
# 7 Appendix

## Theorem 1: Posterior of a Beta Proof

Suppose $X \sim Binom(n, \pi_0)$ and we assume $\pi$ follows a Beta distribution with shape parameters $\alpha_0$ and $\beta_0$, $g(\pi_0) = \frac{\Gamma{(\alpha_0+\beta_0)}}{\Gamma{(\alpha_0)}\Gamma{(\beta)}}\pi_0^{\alpha_0-1}(1-\pi_0)^{\beta_0-1}$. Since X is binomial, we have that $P(X=x|\pi=\pi_0) = {n \choose x}\pi_0^x (1-\pi_0)^{n-x}$. We show that the posterior distribution, $h(\pi_0|x) \sim Beta(x+\alpha_0, n-x+\beta_0)$. 
\begin{align*}
h(\pi_0|x) &= \frac{P(X=x|\pi=\pi_0)g(\pi_0)}{\int_0^1 P(X=x|\pi=\pi_0)g(\pi_0)} \\
&= \frac{{n \choose x} \pi_0^x (1-\pi_0)^{n-x}\Gamma{(\alpha_0+\beta_0)}\pi_0^{\alpha_0-1}(1-\pi_0)^{\beta_0-1}}{\Gamma{(\alpha_0)}\Gamma{(\beta)} \int_0^1 {n \choose x} \pi_0^x (1-\pi_0)^{n-x}\frac{\Gamma{(\alpha_0+\beta_0)}}{\Gamma{(\alpha_0)}\Gamma{(\beta)}}\pi_0^{\alpha_0-1}(1-\pi_0)^{\beta_0-1}}
&= \frac{{n \choose x} (1-\pi_0)^{n-x+\beta_0-1}\pi_0^{\alpha_0-1+x}}{\int_0^1 {n \choose x}(1-\pi_0)^{n-x+\beta_0-1}\pi_0^{\alpha_0-1+x}}
\end{align*}
By observing the terms in the numerator, this is recognizable as the PDF of a Beta distribution with parameter $\alpha = x+1$ and $\beta = n - x + 1$. So, $h(\pi_0|x) \sim Beta(x+\alpha_0, n-x+\beta_0)$. $\blacksquare$

## Theorem 2: Jefferies Prior

Given $T \sim Binom(170,\pi)$, we know that when s is large (170) and $\pi$ is small the binomial distribution is well approximated by a poisson distribution, $U \sim Pois(170\pi)$. 

Jefferies Prior is defined to be $g(\lambda) \propto \sqrt{I(\lambda)}$ with $I(\lambda)$ being the Fishers Information matrix, where this can be evaluated as: $g(\lambda) \propto \sqrt{-E \left[\frac{d^2}{d\lambda^2}ln(f(u|\lambda)) \right]}$

For the poisson distribution we calculate the likelihood give we observe n infections, we can write: $f(u|\lambda)= \frac{\lambda^ue^{-\lambda}}{u!}$. Taking the log-likelihood: $ln(L(\lambda)) = \frac{\lambda^ux^{-u}}{u!}$
\begin{align*}
\ln(L(\lambda)) &= \ln(\frac{\lambda^ue^{-\lambda}}{u!}) \\
&= u\ln(\lambda) - u - \ln(u!)
\end{align*}
We can take the first and second derivative of this with respect to $\lambda$. First derivative: $\frac{d}{d\lambda} (u\ln(\lambda) - u - \ln(u!)) = \frac{u}{\lambda}$. Second derivative: $\frac{d}{d\lambda}(\frac{u}{\lambda}) = -\frac{u}{\lambda^2}$. If we take the expected value of this, it results in the final result:
\begin{align*}
E \left[\frac{d^2}{d\lambda^2}ln(f(u|\lambda)) \right] &= E[-\frac{u}{\lambda^2}] \\
&= -\frac{1}{\lambda^2} E[U] \\
&= -\frac{\lambda}{\lambda^2} \ \ \text{Expected value of a poisson is the rate parameter} \\
&= -\frac{1}{\lambda}
\end{align*}

Since we have that $g(\lambda) \propto \sqrt{-E \left[\frac{d^2}{d\lambda^2}ln(f(u|\lambda)) \right]}$, we plug in the value calculated and see that $g(\lambda) \propto \sqrt{\frac{1}{\lambda}}$, which is often expressed as the improper $Gamma(\frac{1}{2},0)$ distribution.

For find the general form of the posterior that is applicable in any context, we will define a poisson distribution with rate parameter $\lambda$, $X_i \sim Pois(\lambda)$ with n, iid, $X_i$'s. We also define $g(\lambda) = Gamma(\alpha, \beta)$

\begin{align*}
h(\lambda|x) = \frac{\frac{e^{-n\lambda}\lambda^{n\bar{x}}}{\prod_{i=1}^n (x_i)!}\frac{\beta^\alpha}{\Gamma(\alpha)}\lambda^{\alpha-1}e^{-\beta\lambda}}{\int_0^{\infty} \frac{e^{-n\lambda}\lambda^{n\bar{x}}}{\prod_{i=1}^n (x_i)!}\frac{\beta^\alpha}{\Gamma(\alpha)}\lambda^{\alpha-1}e^{-\beta\lambda} d\lambda}
\end{align*}

After canceling constants we are left with $h(\lambda|x) \propto e^{-n\lambda}\lambda^{n\bar{x}} \lambda^{\alpha-1}e^{-\beta\lambda} = e^{-n\lambda + -\beta\lambda}\lambda^{n\bar{x}+\alpha-1}$. Which follows $Gamma(n\bar{x}+\alpha, n + \beta)$. We can now use this posterior and plug in our own values. We know that the prior follows a $Gamma(\frac{1}{2},0)$ distribution, so $Gamma(n\bar{x}+\frac{1}{2}, n + 0)$. We have that s = 170, so there are 170 total positive cases for n. Then there are 8 individuals in the vaccine group within these 170 positive cases, so $n\bar{x} = 8$ and the posterior is defined to be $Gamma(8+\frac{1}{2}, 170)$ $\blacksquare$

## Prior & Posterior Medians

Let $\phi$ represent the posterior median for pi, then all posterior medians for $\psi_0$ will be found by:
\begin{align*}
P(\pi < \phi) &= 0.5 \\
P(\frac{1-\psi}{2-\psi} < \phi) &= 0.5 \\
P(1-\psi < \phi(2-\psi)) &= 0.5 \\
P(1-2\phi < \psi - \psi\phi) &= 0.5 \\
P(\frac{1-2\phi}{1-\phi} < \psi) &= 0.5
\end{align*}
To test the hypothesis we have that
\begin{align*}
P(\psi_0 < 0.3) &= P(\frac{1-2\pi_0}{1-\pi_0} < 0.3) \\
&= P(1-2\pi_0 < 0.3(1-\pi_0)) \\
&= P(1-0.3 < 2\pi_0-0.3\pi_0) \\
&= P(\frac{0.7}{1.7} < \pi_0)
\end{align*}

## Prior 1 Calculations

```{r code prior1, eval=F}
# 95% Credible interval for pi
pi_ci <- qbeta(p=c(0.025,0.975), 8.700102, 163)

# 95% Credible interval for psi
upper_ci_prior1 <- (1-2*pi_ci[1])/(1-pi_ci[1])
lower_ci_prior1 <- (1-2*pi_ci[2])/(1-pi_ci[2])

# Posterior Median for pi
postmedian1 <- qbeta(0.5, 8.700102, 163)

# Posterior Median for psi
postmedian1_psi <- (1-2*postmedian1)/(1-postmedian1)

# Posterior p-value for psi
postpval1 <- pbeta(0.7/1.7, 8.700102, 163, lower.tail=F)
```



## Prior 2 Calculations

\begin{align*}
P(\psi_0 < 0.2) &= P(\frac{1-2\pi_0}{1-\pi_0} < 0.2) \\
&= P(1-2\pi_0 < 0.2(1-\pi_0)) \\
&= P(1-0.2 < 2\pi_0-0.2\pi_0) \\
&= P(\frac{0.8}{1.8} < \pi_0)
\end{align*}


```{r}
quantile1 = list(p = 0.5, x = 0.50)
quantile2 = list(p = 0.05, x = 0.8/1.8)
params <- beta.select(quantile1,quantile2)

pi_ci2 <- qbeta(p=c(0.025,0.975), 109.29+8, 109.29+162)

# 95% Credible interval for psi
upper_ci_prior2 <- (1-2*pi_ci2[1])/(1-pi_ci2[1])
lower_ci_prior2 <- (1-2*pi_ci2[2])/(1-pi_ci2[2])

# Posterior Median for pi
postmedian2 <- qbeta(0.5, 86.04+8, 86.04+162)

# Posterior Median for psi
postmedian2_psi <- (1-2*postmedian2)/(1-postmedian2)

# Posterior p-value for psi
postpval2 <- pbeta(0.7/1.7, 86.04+8, 86.04+162, lower.tail=F)
```


## Prior 3 Calculations

```{r code prior3, eval=F}
# Upper and lower bounds for pi credible interval
lower_gamma <- qgamma(0.025, 1/2+8, 170)
upper_gamma <- qgamma(0.975, 1/2+8, 170)
# 95% Credible Interval for psi
upper_ci_prior3 <- (1-2*lower_gamma)/(1-lower_gamma)
lower_ci_prior3 <- (1-2*upper_gamma)/(1-upper_gamma)
# Posterior Median for pi
postmedian1 <- qgamma(0.5, 1/2+8, 170)
# Posterior Median for psi
postmedian1_psi <- (1-2*postmedian1)/(1-postmedian1)
# Posterior p-value for psi
postpval1 <- pgamma(0.7/1.7,1/2+8, 170, lower.tail=F)
```


## Likelihood Calculations

```{r, eval=F}

t <- 8 #Observed 8 COVID-19 cases in vaccine group over total number of cases

# Calculate MLE Given equation
mle_psi <- (2*t-170)/(t-170)

# Calculate estimated standard error of Psi given equation
psi_se <- 1/sqrt((1/t-1/170)*(t-170)^2)

# 99% Wald Confidence Interval
lower_ci_wald <- mle_psi - qnorm(0.975) * psi_se
upper_ci_wald <- mle_psi + qnorm(0.95) * psi_se

# W statistic, likelihood ratio test
w_obs <- 2 * log((((1-mle_psi)/(2-mle_psi))^8 *
                    (1/(2-mle_psi))^162)/
                   (((1-0.3)/(2-0.3))^8 * (1/(2-0.3))^162))

#Likelihood Ratio test p-value
p_value <- pchisq(w_obs, df=1, lower.tail=F)
```


## Regulatory Conditions for Likelihood
```{r, eval=F}
# Log-likelihood function
loglik.psi <- function(psi){
  ifelse(psi > 1, NA,
         log(choose(170,8)+8*log(1-psi)-170*log(2-psi)))
}

# Second order taylor approximation of the log-likelihood
second_order <- maxLik2(loglik=loglik.psi,
                        start=mle_psi,
                        method="NR")
# Plot this taylor approximation
ts_plot <- plot(second_order) %>%
  gf_labs(title="Second Order Taylor Series Approximation of Log-Likelihood of
          Psi", x=expression(psi), y="Log-Likelihood")
```


## Bootstrap Confidence Interval

```{r ref.label="bootstrap", echo=TRUE, eval=F}
```