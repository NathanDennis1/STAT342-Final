---
title: "Unmasking the Numbers: An Analysis of the BNT162b2 mRNA Covid-19 Vaccine Efficacy Rate"
subtitle: "Frequentist and Bayesian Analysis of Polack et. al."
graphics: yes
author: "Nathan Dennis, Aarav Dewangan, Maxwell Wang"
date: "2023-05-26"
output: 
        pdf_document:
         toc: false
         number_sections: false
urlcolor: blue
header-includes:
- \usepackage{amsmath,amsfonts,amssymb}
- \usepackage{multicol,graphicx,hyperref,xcolor}
- \usepackage{setspace} \doublespacing
fontsize: 11pt
---

\begin{table}[ht]
\centering
\caption{Sample Table}
\begin{tabular}{|c|c|c|}
\hline
Groups & Cases & No. of Subjects \\
\hline
BNT162b2 & 8 & 17,411 \\
\hline
Placebo & 162 & 17,511 \\
\hline
Total & 170 & 34,922 \\

\hline
\end{tabular}
\end{table}


## Abstract



## Keywords

COVID-19, Vaccine, Efficacy, Immunization, Analysis

## Introducton

<include> BNT162b2 mRNA Covid-19 Vaccine, which we will refer to subsequently as simply "vaccine"

## Large Sample T-Test

We'll assume the infection status of each patient is a Bernoulli Random Variable, where the success rate $\pi$ determines the probability that a patient contracted Covid-19 during the study.

Let us define $X_1, X_2, \dots, X_n \overset{i.i.d.}{\sim} \mbox{Bernoulli}(\pi_p)$ and $Y_1, Y_2, \dots, Y_m \overset{i.i.d.}{\sim} \mbox{Bernoulli}(\pi_v)$. $X_i$'s represent the infection status of patients who received the placebo, and $Y_i$'s represent the infection status of patients who received the COVID-19 vaccine.

<TODO>?
The efficacy rate is defined as $1 - \frac{\pi_v}{\pi_p}$, so let's define the random variable Z to represent the estimated efficacy rate from our data, where $Z = 1 - \frac{\bar{Y}}{\bar{X}}$. We want to see whether or not the efficacy rate exceeds the 30\% as required by the FDA.

From our data, our estimated efficacy
$\hat\psi=\frac{\hat \pi_p-\hat \pi_v}{\hat \pi_p}$
$\hat\psi=0.950334$
<TODO>?

We'll assume that the sample size is sufficiently large, since $n = 17511$ and $m = 17411$. Then the Central Limit Theorem should hold, so then $\bar{X} \sim \mbox{Norm}(\mu_x, \frac{\sigma_x}{\sqrt{n}})$ and $\bar{Y} \sim \mbox{Norm}(\mu_y, \frac{\sigma_y}{\sqrt{m}})$. The mean of a Bernoulli random variable with probability $\pi$ is $\pi$ and the variance is $\pi(1 - \pi)$.

Therefore, $\bar{X} \sim \mbox{Norm}(\pi_p, \sqrt{\frac{\pi_p(1 - \pi_p)}{n}})$ and $\bar{Y} \sim \mbox{Norm}(\pi_v, \sqrt{\frac{\pi_v(1 - \pi_v)}{m}})$.

$xbar - ybar +- z_alpha/2 sqrt(sigma1^2/n + sigma2^2/m)$

$xbar Sim Norm (mu1, sigma1 / sqrt(n))$

We will define null hypothesis $H_0$: $Z = .3$, which represents the vaccine having 30\% efficacy.
We will define the one-sided alternative hypothesis $H_a$: $Z > .3$ representing that the vaccine has an efficacy greater than 30\%.

We will define null hypothesis $H_0$: $\pi_p = \pi_v$, which represents the vaccine having no affect on getting infected with Covid-19 compared with the placebo.

We will define the one-sided alternative hypothesis $H_a$: $\pi_v < \pi_p$ representing that vaccinated patients are less likely to get infected with Covid-19 than patients who received the placebo.



## Statistical Methods

We will use parameters $\pi_p$ to represent the likelihood of being infected with Covid-19 after taking the placebo, and $\pi_v$ to represent the likelihood of getting Covid-19 after receiving the vaccine.

We will define null hypothesis $H_0$: $\pi_p = \pi_v$, which represents the vaccine having no affect on getting infected with Covid-19 compared with the placebo.

We will define the one-sided alternative hypothesis $H_a$: $\pi_v < \pi_p$ representing that vaccinated patients are less likely to get infected with Covid-19 than patients who received the placebo.

Let X denote the total number of laboratory confirmed Covid-19 cases among $n_1$(17411) subjects randomly assigned to the BNT162b2 group and let Y denote the total number of laboratory confirmed Covid-19 cases among $n_2$(17511) subjects randomly assigned to the placebo group.\

$X \sim Binom(n_1,\pi_v)$\
$Y \sim Binom(n_2,\pi_p)$\
The parameter of interest is the BNT162b2 efficacy:\
$\psi=\frac{\pi_p- \pi_v}{\pi_p}$\

Let $\pi_v=\mbox{probability of laboratory confirmed Covid-19 cases in vaccine}$\
Let $\pi_p=\mbox{probability of laboratory confirmed Covid-19 cases in placebo}$\
From the data table, we see that:\
$\hat \pi_v=\frac{8}{17411}$\
$\hat \pi_p=\frac{162}{17511}$\
$\hat\psi=\frac{\hat \pi_p-\hat \pi_v}{\hat \pi_p}$\
$\hat\psi=\frac{\frac{162}{17511}-\frac{8}{17411}}{\frac{162}{17511}}$\
$\hat\psi=\frac{446749}{470097}$\
$\hat\psi=0.950334$\

We see that vaccine reduces the size of the Covid 19 by 95\% compared to placebo.\
Specifically, assuming the trial will run until X+Y=s Covid cases observed, we consider the distribution of :\
$T:\mbox{number of covid cases in BNT162b2 group from these s cases}$\
The distribution of T well approximated by binomial for the BNT162b2 group study. Therefore:\
$T \sim Binom(s,\pi)$, where $\pi=P(\mbox{BNT162b2 group}|\mbox{laboratory confirmed Covid-19 cases})$\


$\pi=P(\mbox{BNT162b2 group}|\mbox{laboratory confirmed Covid-19 cases})$\
 Using Bayes Theorem to simplify:\
$\pi=\frac{P(\mbox{laboratory confirmed Covid-19 cases}|\mbox{BNT162b2 group})P(\mbox{BNT162b2 group})}{P(\mbox{laboratory confirmed Covid-19 cases})}$\

Finding $P(\mbox{laboratory confirmed Covid-19 cases})$:\
$P(\mbox{laboratory confirmed Covid-19 cases})=\pi_v$\

Finding $P(\mbox{BNT162b2 group})$:\
$P(\mbox{BNT162b2 group})=\frac{n_1}{n_1+n_2}$\

Finding $P(\mbox{laboratory confirmed Covid-19 cases})$:\
$P(\mbox{laboratory confirmed Covid-19 cases})$\
$=\frac{\mbox{Total no. of confirmed Covid-19 cases in vaccine + Total no. of confirmed Covid-19 cases in placebo} }{\mbox{Total number of subjects in vaccine + Total number of subjects in plcebo }}$\
$=\frac{n_1\pi_v+n_2\pi_p}{n_1+n_2}$\
$P(\mbox{laboratory confirmed Covid-19 cases})=\frac{n_1\pi_v+n_2\pi_p}{n_1+n_2}$\

Therefore:\
$\pi=\frac{\pi_v\cdot \frac{n_1}{n_1+n_2}}{\frac{n_1\pi_v+n_2\pi_p}{n_1+n_2}}$\
$=\frac{\frac{n_1\pi_v}{n_1+n_2}}{\frac{n_1\pi_v+n_2\pi_p}{n_1+n_2}}$\
$=\frac{n_1\pi_v}{n_1+n_2}$\
$\pi=\frac{n_1\pi_v}{n_1\pi_v+n_2\pi_p}$\
When $n_1\approx n_2$, we say randomization is 1:1 and are able to simplify $\pi$ further:\
$\pi=\frac{\pi_v}{\pi_v+\pi_p}$\

Thus $T \sim Binom(s,\pi=\frac{\pi_v}{\pi_v+\pi_p})$\
Our parameter of interest is:\
$\psi=\frac{\pi_p- \pi_v}{\pi_p}=1-\frac{\pi_v}{\pi_p}$\
We know $\pi=\frac{\pi_v}{\pi_v+\pi_p}$\
$\implies \pi(\pi_v+\pi_p)=\pi_v$\
$\implies \pi\pi_v+\pi\pi_p=\pi_v$\
$\implies \pi\pi_p=\pi_v(1-\pi)$\
$\implies \pi_v=\frac{\pi\pi_p}{1-\pi}$\

$\psi=1-\frac{\pi_v}{\pi_p}$\
$\implies 1-\frac{\pi\pi_p}{(1-\pi)\pi_p}$\
$\implies 1-\frac{\pi}{1-\pi}$\
$\implies \frac{1-2\pi}{1-\pi}$\
$\psi=\frac{1-2\pi}{1-\pi}$\

We know that $T\sim Binom(170,\pi)$ where $\pi=\frac{\pi_v}{\pi_v+\pi_p}$ and\
$g(\pi) = Beta(0.700102,1)$\
We know beta is a conjugate prior in the binomial model. In the other words, posterior distribution of $\pi$ is also a beta distribution.\

$h(\pi_0|t)=Beta(0.700102+8,170-8+1)$\
$h(\pi_0|t)=Beta(8.700102,163)$\








```{r label ="bayesian", include = FALSE, cache = TRUE}


```


## Max-Likelihood

We want to make a maximum-likelihood estimator for $\psi$, $\widehat{\psi^{mle}}$, given the observed data. Let us start by writing the likelihood function. We have proved previously that $T\sim Binom(170,\pi)$, where the distribution would bd defined as: $f(t) = {170\choose t} \pi^t \cdot (1 - \pi)^{170-t}$. We need to reparamaterize this with $\psi$, which represents the number of patients who contracted COVID who had initially been in the vaccinated group rather than the placebo one. We use the fact that $\psi = \frac{1-2\pi}{1-\pi}$, where we can rearrange terms:

$\textbf{Lemma 1.}$
\begin{align*}
\psi &= \frac{1-2\pi}{1-\pi} \\
(1-\pi)\psi &= 1-2\pi \\
\psi - \pi \psi &= 1-2\pi \\
2\pi - \pi \psi &= 1 - \psi \\
\pi &= \frac{1 -\psi}{2-\psi} \\
\end{align*}

We now have that $f(t) = {170\choose t} (\frac{1 -\psi}{2-\psi})^t \cdot (1 - \frac{1 -\psi}{2-\psi})^{170-t}$. So the likelihood function is as follows: 

\begin{align*}
L(\psi) &= f(t | \psi) \\;
&= {170\choose t} (\frac{1 -\psi}{2-\psi})^t \cdot (1 - \frac{1 -\psi}{2-\psi})^{170-t} & \text{Lemma 1} \\
&= {170\choose t} (\frac{1 -\psi}{2-\psi})^t \cdot (\frac{1}{2-\psi})^{170-t}\\
\end{align*}

Next, we compute the log-likelihood function:

\begin{align*}
\ln(L(\psi)) &= \ln(f(t | \psi)) \\
&= \ln \left({170\choose t} (\frac{1 -\psi}{2-\psi})^t \cdot (\frac{1}{2-\psi})^{170-t} \right) \\
&= \ln{170\choose t} + \ln\left((\frac{1 -\psi}{2-\psi})^t \right) + \ln \left((\frac{1}{2-\psi})^{170-t} \right) \\
&= \ln{170\choose t} + t\ln(\frac{1 -\psi}{2-\psi}) + (170-t)\ln(\frac{1}{2-\psi}) \\
\end{align*}

To find the maximum of the likelihood function, take the derivative and set it to zero and solve:

\begin{align*}
\frac{d}{d\psi} \ln(L(\psi)) &= \frac{d}{d\psi} \ln(f(t | \psi)) \\
&= \frac{d}{d\psi} \ln{170\choose t} + t\ln(\frac{1 -\psi}{2-\psi}) + (170-t)\ln(\frac{1}{2-\psi}) \\
&= t \frac{2 -\psi}{1-\psi} \cdot (-\frac{1}{(2 -\psi)^2}) + (170-t)(2-\psi) \cdot (\frac{1}{(2 -\psi)^2})\\
0 &= -\frac{t}{(1-\psi)(2 -\psi)} + (170-t) \cdot \frac{1}{(2 -\psi)}\\
\frac{t}{(1-\psi)(2 -\psi)} &= (170-t)\frac{1}{(2 -\psi)}\\
\frac{8}{(1-\psi)(2 -\psi)} &= (170-8)\frac{1}{(2 -\psi)}\\
\frac{8}{162} &= \frac{(1-\psi)(2 -\psi)}{(2 -\psi)}\\
\frac{8}{162} &= 1-\psi\\
\psi &= 1 - \frac{8}{162}
\end{align*}

```{r}
1-8/162
77/81
```

To check whether our value of $\psi = 77/81$ is a global maximum, we will take the second derivative of our log-likelihood function.


\begin{align*}
\frac{d^2}{d\psi^2} \ln(L(\psi)) &= \frac{d}{d\psi} [t \frac{2 -\psi}{1-\psi} \cdot (-\frac{1}{(2 -\psi)^2}) + (170-t)(2-\psi) \cdot (\frac{1}{(2 -\psi)^2})] \\
&= \frac{d}{d\psi} [\frac{-t}{(1-\psi)(2 - \psi)} + \frac{(170-t)}{(2-\psi)}]\\
&= \frac{d}{d\psi} [-t (2 - 3\psi + \psi^2)^{-1} + (170 - t)(2-\psi)^{-1}] \\
\end{align*}


## Results


## Discussion/Conclusion


## References


## Appendix

```{r ref.label="bayesian", echo=TRUE, eval=F}
```
